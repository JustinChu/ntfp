#!/usr/bin/make -Rrf
ifdef profile
SHELL=/usr/bin/time -f '=> jupiter: %e %C' /bin/bash -o pipefail
else
SHELL=/bin/bash -o pipefail
endif

ROOT_DIR:=$(shell dirname $(realpath $(lastword $(MAKEFILE_LIST))))

#------------------------------------------------------------
# params
#------------------------------------------------------------

w=31 #window size to consider sequences in this region
k=19 #kmer size used in window region
t=4 #threads for any subprocess or tools
n=0 #number of sub k-mers to allow

#------------------------------------------------------------
# meta rules
#------------------------------------------------------------

.PRECIOUS: %.sam %.ann %.amb %.bwt %.pac %.sa
.DELETE_ON_ERROR:
.PHONY: check-params generate-sites

default: generate-sites

generate-sites: check-params $(name).fa

check-name-param:
ifndef name
	$(error missing required param 'name' (output file prefix))
endif

check-params: check-name-param
ifndef ref
	$(error missing required param 'ref' (FASTA reference file))
endif
ifndef vcf
	$(error missing required param 'vcf' (vcf file containing variants file))
endif

#------------------------------------------------------------
# pipeline rules
#------------------------------------------------------------

$(name)_reference.fa: $(ref)
	ln -s $< $@
	
$(name)_snps.vcf: $(vcf)
	ln -s $< $@

#index reference file
%.ann %.amb %.bwt %.pac %.sa : %.fa
	samtools index $<

#create snp sub k-mer fasta files
%_subKmers.fa: %_snps.vcf %_reference.fa
	python $(ROOT_DIR)/extractSNPsfromVCF.py -v $< -f $*_reference.fa -s $(k) -k $(w) -p test > $@

#check for k-mer uniqueness via alignment
%.sai: %_subKmers.fa $(name)_reference.fa %_reference.fa.ann %_reference.fa.amb %_reference.fa.bwt %_reference.fa.pac %_reference.fa.sa
	bwa aln -t $(t) -n 1 $(name)_reference.fa $< > $@

%.sam: %.sai %_subKmers.fa $(name)_reference.fa
	bwa samse $(name)_reference.fa $< $(name)_subKmers.fa > $@

#filter repetitive sub k-mers & create concatenated sub k-mer fasta files
$(name).fa: $(name).sam
	perl ~/git/ntsm/scripts/filterRepetiveSNP.pl <(samtools view $<) $(n) > $@
